<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chrome PDF Dark Mode Bookmarklet Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --panel-bg: #161b22;
      --panel-border: #262b33;
      --panel-radius: 12px;
      --accent: #3b82f6;
      --text-muted: #9ba0a8;
      --page-bg: #0f111e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: var(--page-bg);
      color: #f1f5f9;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    a {
      color: #90cdf4;
    }

    header {
      padding: 1.5rem;
      border-bottom: 1px solid #1f2532;
    }

    header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.85rem;
      letter-spacing: 0.01em;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      max-width: 720px;
    }

    main {
      display: flex;
      flex: 1;
      gap: 1.5rem;
      padding: 1.5rem;
      flex-wrap: wrap;
    }

    /* New: left column wrapper so controls + bookmarklet stack vertically */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 0 0 360px;
    }

    .controls {
      flex: 0 0 320px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--panel-radius);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .controls h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .field label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .field label span {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.85rem;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    input[type="color"] {
      width: 100%;
      height: 2.5rem;
      border: none;
      border-radius: 8px;
      padding: 0;
      cursor: pointer;
      background: transparent;
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .checkbox-field input {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .checkbox-field span {
      font-weight: 600;
      color: #f1f5f9;
    }

    .action-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 0.6rem 1rem;
      color: #f8fafc;
      background: var(--accent);
      transition: background 0.2s ease;
    }

    button:hover {
      background: #2563eb;
    }

    button.secondary {
      background: transparent;
      color: #cbd5f5;
      border: 1px solid var(--panel-border);
    }

    .preview {
      flex: 1 1 480px;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .preview-card {
      flex: 1;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--panel-radius);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--panel-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .preview-header h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .preview-scene {
      flex: 1;
      position: relative;
      background: #111111;
      display: flex;
    }

    .preview-scene object {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
      /* Ensure the PDF sits above the backdrop color layer */
      position: relative;
      z-index: 1;
    }

    .preview-backdrop {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: transparent;
      transition: background 0.2s ease;
      /* Place the backdrop below the PDF content */
      z-index: 0;
    }

    .preview-fallback {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
      background: rgba(15, 17, 30, 0.9);
      color: var(--text-muted);
      gap: 0.5rem;
      flex-direction: column;
    }

    .output-card {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: var(--panel-radius);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      background: #0b101a;
      color: #f8fafc;
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      padding: 1rem;
      font-family: "JetBrains Mono", "Cascadia Code", Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      resize: vertical;
    }

    textarea:focus {
      outline: 2px solid var(--accent);
      outline-offset: 0;
    }

    .status-line {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .status-line strong {
      color: #e2e8f0;
      font-weight: 600;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    @media (max-width: 960px) {
      main {
        flex-direction: column;
      }

      .sidebar, .controls {
        width: 100%;
        flex: none;
      }

      .preview {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Chrome PDF Dark Mode Bookmarklet Builder</h1>
  </header>
  <main>
    <section class="sidebar" aria-label="Controls and bookmarklet">
      <section class="controls" aria-label="Filter controls">
        <h2>Filter Controls</h2>
        <form id="controlForm" data-form>
          <div class="field">
            <label for="invert">Invert<span data-value="invert">95%</span></label>
            <input type="range" id="invert" name="invert" min="0" max="1" step="0.01" value="0.95">
          </div>
          <div class="field">
            <label for="hue">Hue Rotate<span data-value="hue">180&deg;</span></label>
            <input type="range" id="hue" name="hue" min="0" max="360" step="1" value="180">
          </div>
          <div class="field">
            <label for="sepia">Sepia<span data-value="sepia">30%</span></label>
            <input type="range" id="sepia" name="sepia" min="0" max="1" step="0.01" value="0.30">
          </div>
          <div class="field">
            <label for="brightness">Brightness<span data-value="brightness">100%</span></label>
            <input type="range" id="brightness" name="brightness" min="0.5" max="1.5" step="0.01" value="1">
          </div>
          <div class="field">
            <label for="contrast">Contrast<span data-value="contrast">100%</span></label>
            <input type="range" id="contrast" name="contrast" min="0.5" max="1.5" step="0.01" value="1">
          </div>
          <div class="field">
            <label for="saturate">Saturate<span data-value="saturate">100%</span></label>
            <input type="range" id="saturate" name="saturate" min="0" max="2" step="0.01" value="1">
          </div>
        
          <label class="checkbox-field" for="colorScheme">
            <input type="checkbox" id="colorScheme" name="colorScheme" checked>
            <span>Force color-scheme: dark</span>
          </label>
          <div class="action-bar" aria-label="Bookmarklet actions">
            <button type="button" id="copyButton">Copy Bookmarklet</button>
            <button type="button" id="resetButton" class="secondary">Reset to Defaults</button>
          </div>
          <p class="hint">Tip: Drag the values to see the live PDF preview update before copying the bookmarklet.</p>
        </form>
      </section>
      <div class="output-card">
        <div class="status-line">
          <span><strong>Filter chain:</strong> <span data-filter-display>invert(0.95) hue-rotate(180deg) sepia(0.30)</span></span>
        </div>
        <textarea id="bookmarklet" aria-label="Generated bookmarklet" readonly></textarea>
        <p class="hint">Add the bookmarklet to Chrome by dragging the link from this textarea to your bookmarks bar, or create a new bookmark and paste the code into the URL field.</p>
      </div>
    </section>
    <section class="preview" aria-label="Live preview">
      <div class="preview-card">
        <div class="preview-header">
          <h2>Live PDF Preview</h2>
          <small id="statusHint">Previewing 1706.03762v7.pdf</small>
        </div>
        <div class="preview-scene" id="previewScene">
          <object id="previewPdf" data="1706.03762v7.pdf#toolbar=0&amp;navpanes=0&amp;scrollbar=0" type="application/pdf">
            <p>This browser cannot show embedded PDF previews. <a href="1706.03762v7.pdf" target="_blank" rel="noopener">Open the file in a new tab</a>.</p>
          </object>
          <div class="preview-backdrop" id="previewBackdrop"></div>
          <div class="preview-fallback" id="previewFallback" hidden>
            <strong>Preview PDF missing?</strong>
            <span>Place <code>1706.03762v7.pdf</code> next to this HTML file to enable the live preview.</span>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script>
    (function () {
      const defaults = {
        invert: 0.95,
        hue: 180,
        sepia: 0,
        brightness: 1,
        contrast: 1,
        saturate: 0.5,
        colorScheme: true
      };

      const form = document.querySelector("[data-form]");
      const controls = {
        invert: form.querySelector("#invert"),
        hue: form.querySelector("#hue"),
        sepia: form.querySelector("#sepia"),
        brightness: form.querySelector("#brightness"),
        contrast: form.querySelector("#contrast"),
        saturate: form.querySelector("#saturate"),
        colorScheme: form.querySelector("#colorScheme")
      };

      const display = {
        invert: form.querySelector('[data-value="invert"]'),
        hue: form.querySelector('[data-value="hue"]'),
        sepia: form.querySelector('[data-value="sepia"]'),
        brightness: form.querySelector('[data-value="brightness"]'),
        contrast: form.querySelector('[data-value="contrast"]'),
        saturate: form.querySelector('[data-value="saturate"]'),
        filter: document.querySelector('[data-filter-display]'),
        
      };

      const previewPdf = document.getElementById("previewPdf");
      const previewBackdrop = document.getElementById("previewBackdrop");
      const previewFallback = document.getElementById("previewFallback");
      const bookmarkletField = document.getElementById("bookmarklet");
      const copyButton = document.getElementById("copyButton");
      const resetButton = document.getElementById("resetButton");
      const statusHint = document.getElementById("statusHint");

      const percent = (value) => Math.round(Number(value) * 100) + "%";
      const toFixed = (value, digits = 2) => Number(value).toFixed(digits);

      function getState() {
        return {
          invert: parseFloat(controls.invert.value),
          hue: parseFloat(controls.hue.value),
          sepia: parseFloat(controls.sepia.value),
          brightness: parseFloat(controls.brightness.value),
          contrast: parseFloat(controls.contrast.value),
          saturate: parseFloat(controls.saturate.value),
          colorScheme: controls.colorScheme.checked
        };
      }

      function buildFilterChain(state) {
        const parts = [];
        if (state.invert > 0) {
          parts.push(`invert(${toFixed(state.invert)})`);
        }
        if (state.hue !== 0) {
          parts.push(`hue-rotate(${toFixed(state.hue, 0)}deg)`);
        }
        if (state.sepia > 0) {
          parts.push(`sepia(${toFixed(state.sepia)})`);
        }
        if (state.brightness !== 1) {
          parts.push(`brightness(${toFixed(state.brightness)})`);
        }
        if (state.contrast !== 1) {
          parts.push(`contrast(${toFixed(state.contrast)})`);
        }
        if (state.saturate !== 1) {
          parts.push(`saturate(${toFixed(state.saturate)})`);
        }
        return parts.join(" ");
      }

      function buildCss(state) {
        const cssLines = [
          'html[data-pdf-viewer-done="true"],',
          'body > embed[type="application/pdf"] {'
        ];

        const filterChain = buildFilterChain(state);
        cssLines.push(`  filter: ${filterChain || "none"};`);
        if (state.colorScheme) {
          cssLines.push("  color-scheme: dark;");
        }
        cssLines.push("}");

        return cssLines.join("\n");
      }

      function buildBookmarklet(cssText) {
        const cssLiteral = JSON.stringify(cssText);
        return "javascript:(function(){" +
          "var id='pdf-dark-mode-style';" +
          "var style=document.getElementById(id);" +
          "if(style){style.remove();return;}" +
          "style=document.createElement('style');" +
          "style.id=id;" +
          "style.textContent=" + cssLiteral + ";" +
          "document.head.appendChild(style);" +
          "})();";
      }

      function updateDisplay(state) {
        display.invert.textContent = percent(state.invert);
        display.hue.innerHTML = `${toFixed(state.hue, 0)}&deg;`;
        display.sepia.textContent = percent(state.sepia);
        display.brightness.textContent = percent(state.brightness);
        display.contrast.textContent = percent(state.contrast);
        display.saturate.textContent = percent(state.saturate);

        const filterChain = buildFilterChain(state) || "none";
        display.filter.textContent = filterChain;
      }

      function updatePreview(state) {
        const filterChain = buildFilterChain(state);
        previewPdf.style.filter = filterChain || "none";
      }

      function updateBookmarklet(state) {
        const cssText = buildCss(state);
        const bookmarklet = buildBookmarklet(cssText);
        bookmarkletField.value = bookmarklet;
      }

      function updateAll() {
        const state = getState();
        updateDisplay(state);
        updatePreview(state);
        updateBookmarklet(state);
      }

      function applyDefaults() {
        controls.invert.value = defaults.invert;
        controls.hue.value = defaults.hue;
        controls.sepia.value = defaults.sepia;
        controls.brightness.value = defaults.brightness;
        controls.contrast.value = defaults.contrast;
        controls.saturate.value = defaults.saturate;
        controls.colorScheme.checked = defaults.colorScheme;
        updateAll();
      }

      form.addEventListener("input", updateAll);

      copyButton.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(bookmarkletField.value);
          statusHint.textContent = "Bookmarklet copied to clipboard";
          setTimeout(() => {
            statusHint.textContent = "Previewing 1706.03762v7.pdf";
          }, 2400);
        } catch (error) {
          statusHint.textContent = "Press Ctrl+C to copy the bookmarklet";
          setTimeout(() => {
            statusHint.textContent = "Previewing 1706.03762v7.pdf";
          }, 2400);
        }
      });

      resetButton.addEventListener("click", () => {
        applyDefaults();
      });

      previewPdf.addEventListener("load", () => {
        previewFallback.hidden = true;
      });

      previewPdf.addEventListener("error", () => {
        previewFallback.hidden = false;
      });

      applyDefaults();
    })();
  </script>
</body>
</html>
